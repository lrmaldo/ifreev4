# Instrucciones para Actualizar el Webhook de Telegram en Producci√≥n

Estas instrucciones detallan los pasos para aplicar la correcci√≥n del webhook de Telegram en el servidor de producci√≥n.

## Problemas Resueltos

### 1. Error en la firma del m√©todo `handle`

Se ha corregido un error fatal relacionado con la firma del m√©todo `handle` en el controlador `TelegramWebhookController`:

```
Declaration of App\Http\Controllers\TelegramWebhookController::handle(Illuminate\Http\Request $request) must be compatible with DefStudio\Telegraph\Handlers\WebhookHandler::handle(Illuminate\Http\Request $request, DefStudio\Telegraph\Models\TelegraphBot $bot): void
```

### 2. Error en la visibilidad de m√©todos

Se ha corregido un error relacionado con la visibilidad de varios m√©todos:

```
Access level to App\Http\Controllers\TelegramWebhookController::getChatName() must be protected (as in class DefStudio\Telegraph\Handlers\WebhookHandler) or weaker
```

### 3. Error "No TelegraphBot defined for this request"

Se ha corregido un error relacionado con la configuraci√≥n del bot en el m√©todo `bot()`:

```
No TelegraphBot defined for this request
```

Este error ocurre porque el m√©todo `bot()` devuelve una nueva instancia configurada, pero no est√°bamos guardando esta instancia, lo que hac√≠a que se perdiera la configuraci√≥n del bot.

## Pasos para Actualizar en Producci√≥n

### 1. Conectarse al Servidor de Producci√≥n

```bash
ssh usuario@v3.i-free.com.mx
```

### 2. Navegar al Directorio del Proyecto

```bash
cd /var/www/v3.ifree.com.mx
```

### 3. Hacer Backup del Controlador Actual

```bash
cp app/Http/Controllers/TelegramWebhookController.php app/Http/Controllers/TelegramWebhookController.php.bak
```

### 4. Actualizar el C√≥digo del Controlador

Edita el archivo con tu editor preferido (nano, vim, etc.):

```bash
nano app/Http/Controllers/TelegramWebhookController.php
```

> **NOTA IMPORTANTE**: En lugar de editar manualmente el archivo, puede ser m√°s seguro reemplazarlo completamente con la versi√≥n actualizada. Si eliges esta opci√≥n, aseg√∫rate de mantener cualquier configuraci√≥n espec√≠fica del entorno o personalizaci√≥n que pueda existir en el servidor de producci√≥n.

#### 4.1 Corregir el m√©todo `handle`

Busca la definici√≥n del m√©todo `handle` y reempl√°zala por:

```php
/**
 * Maneja las solicitudes webhook entrantes
 * Este m√©todo recibe el webhook y delega a los m√©todos correspondientes
 *
 * @param Request $request
 * @param DefStudio\Telegraph\Models\TelegraphBot $bot
 * @return void
 */
public function handle(Request $request, \DefStudio\Telegraph\Models\TelegraphBot $bot): void
{
    // Registrar recepci√≥n del webhook para diagn√≥stico
    Log::info('Webhook recibido', [
        'content' => $request->getContent(),
        'headers' => $request->headers->all(),
        'bot_id' => $bot->id,
        'bot_name' => $bot->name,
    ]);

    // Si es una solicitud de diagn√≥stico especial, responder directamente
    if ($request->has('diagnostic') && $request->get('diagnostic') === 'true') {
        // No podemos retornar una respuesta directamente debido a la firma del m√©todo
        // Guardaremos un registro para diagn√≥stico
        Log::info('Solicitud de diagn√≥stico recibida', [
            'status' => 'ok',
            'message' => 'Webhook endpoint funcional',
            'timestamp' => now()->toIso8601String(),
            'handler' => get_class($this)
        ]);
        
        // Detener el procesamiento adicional pero sin retornar respuesta
        return;
    }

    if ($this->shouldDebug()) {
        $this->debugWebhook($request);
    }

    // Delegar al manejador base de Telegraph
    parent::handle($request, $bot);
}
```

#### 4.2 Corregir la visibilidad y par√°metros de los m√©todos

Debes cambiar la visibilidad de varios m√©todos auxiliares de `private` a `protected` y ajustar sus par√°metros:

1. Actualiza la firma completa del m√©todo `getChatName`:
```php
/**
 * Obtiene el nombre del chat
 * 
 * @param \DefStudio\Telegraph\DTO\Chat $chat
 * @return string
 */
protected function getChatName(\DefStudio\Telegraph\DTO\Chat $chat): string
```

2. Actualiza la firma completa del m√©todo `getChatType`:
```php
/**
 * Obtiene el tipo de chat
 * 
 * @param \DefStudio\Telegraph\DTO\Chat $chat
 * @return string
 */
protected function getChatType(\DefStudio\Telegraph\DTO\Chat $chat): string
```

3. Cambia de `private function registerChat()` a `protected function registerChat()`
4. Cambia de `private function shouldDebug()` a `protected function shouldDebug()`
5. Cambia de `private function debugWebhook()` a `protected function debugWebhook()`
```

### 5. Actualizar las llamadas a los m√©todos modificados

Debes actualizar todas las llamadas a los m√©todos `getChatName` y `getChatType` para que incluyan el par√°metro `$this->chat`:

```php
// Buscar en registerChat() y cambiar:
$chatData = [
    'chat_id' => $this->chat->chat_id,
    'nombre' => $this->getChatName(),
    'tipo' => $this->getChatType(),
    'activo' => true
];

// Por:
$chatData = [
    'chat_id' => $this->chat->chat_id,
    'nombre' => $this->getChatName($this->chat),
    'tipo' => $this->getChatType($this->chat),
    'activo' => true
];
```

Busca tambi√©n en el m√©todo `ayuda()` y actualiza cualquier otra llamada a estos m√©todos.

### 5.1 Actualizar el m√©todo `ayuda()`

Es crucial mejorar el m√©todo `ayuda()` para utilizar el patr√≥n correcto de env√≠o de mensajes:

```php
/**
 * Maneja el comando /ayuda
 */
public function ayuda(): void
{
    try {
        $telegramChat = TelegramChat::where('chat_id', $this->chat->chat_id)->first();
        $zonasAsociadas = $telegramChat ? $telegramChat->zonas->count() : 0;

        $message = "üìö <b>Ayuda del Bot I-Free</b>\n\n";
        
        // ... (contenido del mensaje)

        // Log para diagn√≥stico
        \Illuminate\Support\Facades\Log::info('Enviando mensaje de ayuda', [
            'chat_id' => $this->chat->chat_id,
            'mensaje' => $message
        ]);

        // REEMPLAZAR ESTA L√çNEA:
        // $response = $this->chat->html($message)->send();
        
        // POR ESTAS L√çNEAS:
        // Obtener el objeto Telegraph para asegurar que se usa la instancia correcta
        $telegraph = app(\DefStudio\Telegraph\Telegraph::class);
        $telegraph->bot($this->bot); // Aseguramos que se use el bot correcto

        // Enviar el mensaje utilizando el cliente Telegraph
        $response = $telegraph->chat($this->chat->chat_id)
            ->html($message)
            ->send();

        // Log de respuesta para diagn√≥stico
        \Illuminate\Support\Facades\Log::info('Respuesta API Telegram (ayuda)', [
            'response' => $response,
            'chat_id' => $this->chat->chat_id,
            'bot_id' => $this->bot->id,
            'bot_name' => $this->bot->name
        ]);
    } catch (\Exception $e) {
        // Capturar cualquier error durante el env√≠o con informaci√≥n detallada
        \Illuminate\Support\Facades\Log::error('Error enviando mensaje ayuda', [
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
            'chat_id' => $this->chat->chat_id ?? 'unknown',
            'bot_id' => $this->bot->id ?? 'unknown'
        ]);
    }
}
```

Este cambio asegura que el m√©todo `ayuda()` utilice el mismo patr√≥n de env√≠o de mensajes que los otros m√©todos, lo cual es cr√≠tico para la consistencia y correcto funcionamiento.

### 6. Corregir Cualquier Ruta de Prueba (Si Existe)

Si hay alguna ruta de prueba en `routes/web.php` que llame al m√©todo `handle` directamente, aseg√∫rate de actualizarla o comentarla.

### 7. Corregir el uso del m√©todo bot() en Telegraph

Debes asegurarte de guardar la instancia devuelta por el m√©todo `bot()`. Busca todos los patrones como este:

```php
$telegraph = app(\DefStudio\Telegraph\Telegraph::class);
$telegraph->bot($this->bot); // INCORRECTO: No guarda la instancia retornada

$telegraph->chat($this->chat->chat_id)
    ->html($mensaje)
    ->send();
```

Y reempl√°zalos con:

```php
$telegraph = app(\DefStudio\Telegraph\Telegraph::class);
$telegraph = $telegraph->bot($this->bot); // CORRECTO: Guarda la instancia retornada

$telegraph->chat($this->chat->chat_id)
    ->html($mensaje)
    ->send();
```

Debes hacer esta correcci√≥n en:

- El m√©todo `start()`
- El m√©todo `zonas()` (hay dos ocurrencias)
- El m√©todo `registrar()`
- El m√©todo `ayuda()`
- El m√©todo `handleChatMessage()`

### 8. Correcci√≥n del problema "bot_id: null" en los logs

Se ha detectado que el webhook recibe correctamente los comandos pero en los logs aparece:

```
"bot_id":null,"bot_name":null
```

Este problema se debe a un conflicto entre las rutas definidas manualmente en `routes/web.php` y la ruta autom√°tica creada por Telegraph.

#### 8.1 Actualizar rutas de webhook

Abre el archivo `routes/web.php` y comenta la ruta manual del webhook:

```php
// Rutas para el webhook de Telegram
// Nota: La ruta principal del webhook es manejada por Telegraph::telegraph() m√°s abajo en este archivo
// Route::post('/telegram/webhook', [TelegramWebhookController::class, 'handle'])
//     ->name('telegram.webhook')
//     ->withoutMiddleware(['web', 'auth', 'verified'])
//     ->middleware(['throttle:100,1']);
```

Aseg√∫rate de que se mantenga la siguiente parte al final del archivo:

```php
// Usamos la macro de Telegraph para registrar su ruta (si est√° disponible)
if (method_exists(\Illuminate\Support\Facades\Route::class, 'telegraph')) {
    \Illuminate\Support\Facades\Route::telegraph();
}
```

Esta correcci√≥n permite que Telegraph gestione correctamente la inyecci√≥n de dependencias del bot, evitando el problema de `bot_id: null` en los logs.

#### 8.2 Verificar la configuraci√≥n de los bots

Para verificar que los bots est√°n correctamente configurados en la base de datos, ejecuta:

```bash
php check-telegraph-bots.php
```

Este script mostrar√° informaci√≥n √∫til sobre los bots registrados y los chats asociados, adem√°s de verificar la configuraci√≥n general de Telegraph.

### 9. Limpiar la Cach√© de Laravel

```bash
php artisan optimize:clear
```

### 10. Verificar la Configuraci√≥n del Webhook

```bash
php artisan telegram:test-webhook --verify
```

### 11. Resetear el Webhook (Si es Necesario)

```bash
php artisan telegram:test-webhook --reset
```

### 12. Verificar los Logs

```bash
tail -f storage/logs/laravel.log
```

### 13. Probar los Comandos

Env√≠a los siguientes comandos al bot y verifica los logs para confirmar que se est√°n procesando correctamente:

```bash
# Monitorear logs mientras pruebas
tail -f storage/logs/laravel.log | grep Telegram
```

1. `/start` - Debe mostrar el mensaje de bienvenida
2. `/zonas` - Debe listar las zonas disponibles  
3. `/ayuda` - Debe mostrar la ayuda detallada (verifica especialmente este comando ya que se actualiz√≥)
4. Mensaje normal "hola" - Debe responder con un mensaje de ayuda

## Verificaci√≥n de Despliegue

Despu√©s de aplicar los cambios, verifica que:

1. No hay errores en los logs del servidor.
2. El bot responde a comandos como `/start`, `/zonas`, etc.
3. Las notificaciones autom√°ticas funcionan cuando se crean nuevas m√©tricas de hotspot.

## Casos de prueba espec√≠ficos

Para verificar que el bot funciona correctamente, puedes usar los scripts de diagn√≥stico creados:

### Probar env√≠o de mensajes directo

```bash
php test-telegram-message.php
```

Este script probar√° el env√≠o de mensajes utilizando tanto el paquete Telegraph como directamente con la API de Telegram.

### Probar simulaci√≥n de webhook

```bash
php test-telegram-webhook.php
```

Este script te permitir√° simular solicitudes de webhook para diferentes comandos y verificar c√≥mo responde el controlador.

### Ejecutar diagn√≥stico completo

```bash
php diagnostico-telegram-respuestas.php
```

Este script realizar√° un diagn√≥stico completo de la configuraci√≥n de Telegram, verificando bots, chats, y la capacidad de enviar mensajes.

## Soluci√≥n de Problemas

Si despu√©s de aplicar los cambios siguen ocurriendo problemas:

### Diagn√≥stico General

1. Verifica la configuraci√≥n del webhook en Telegram utilizando la API:
   ```
   curl https://api.telegram.org/bot<TOKEN>/getWebhookInfo
   ```

2. Aseg√∫rate de que la URL del webhook apunte a `https://v3.i-free.com.mx/telegram/webhook`

3. Revisa los logs del servidor en `storage/logs/laravel.log` para errores espec√≠ficos.

4. Ejecuta el comando de diagn√≥stico completo:
   ```
   php artisan telegram:test-webhook --diagnose
   ```

### Problema: Comandos se procesan pero no hay respuesta

Si los logs muestran que los comandos se reciben correctamente pero el bot no env√≠a respuestas:

1. Ejecuta el script de diagn√≥stico de respuestas:
   ```
   php diagnostico-telegram-respuestas.php
   ```

2. Verifica la conectividad desde el servidor hacia la API de Telegram:
   ```
   curl -v https://api.telegram.org/bot<TOKEN>/getMe
   ```

3. Comprueba los permisos del bot en Telegram (debe tener habilitado el env√≠o de mensajes).

4. Verifica que no haya restricciones de firewall que bloqueen las solicitudes salientes a api.telegram.org.

5. Reinicia el servicio web:
   ```
   sudo systemctl restart apache2   # Si usas Apache
   # O
   sudo systemctl restart nginx php-fpm   # Si usas Nginx + PHP-FPM
   ```

### Problema: Error 500 en las solicitudes webhook

Si el diagn√≥stico muestra "Webhook respondi√≥ con error: HTTP 500":

1. Verifica los logs de PHP/Apache/Nginx para errores espec√≠ficos:
   ```
   sudo tail -f /var/log/apache2/error.log   # Para Apache
   # O
   sudo tail -f /var/log/nginx/error.log     # Para Nginx
   ```

2. Comprueba los permisos de los archivos:
   ```
   sudo chown -R www-data:www-data /var/www/v3.ifree.com.mx/storage
   sudo chmod -R 755 /var/www/v3.ifree.com.mx/storage
   ```

3. Verifica la configuraci√≥n de PHP para asegurarte de que hay suficiente memoria y tiempo de ejecuci√≥n:
   ```
   grep -E 'memory_limit|max_execution_time' /etc/php/*/apache2/php.ini
   # O
   grep -E 'memory_limit|max_execution_time' /etc/php/*/fpm/php.ini
   ```
